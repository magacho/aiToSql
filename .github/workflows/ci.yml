name: CI - Testes AutomÃ¡ticos

on:
  push:
    branches: [ '**' ]  # Todos os branches
  pull_request:
    branches: [ '**' ]

jobs:
  test:
    name: Executar Testes
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: â˜• Configurar JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: ðŸ§ª Executar testes
      run: mvn clean test
      
    - name: ðŸ“Š Gerar relatÃ³rio de cobertura
      run: mvn jacoco:report
      
    - name: ðŸ“ˆ Extrair mÃ©tricas
      id: coverage
      run: |
        COVERAGE=$(awk -F',' '{ instructions += $4 + $5; covered += $5 } END { printf "%.1f", 100*covered/instructions }' target/site/jacoco/jacoco.csv)
        TESTS=$(grep -oP '<test.*?name="\K[^"]+' target/surefire-reports/*.xml 2>/dev/null | wc -l || echo "0")
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "tests=$TESTS" >> $GITHUB_OUTPUT
        echo "âœ… Cobertura: $COVERAGE%"
        echo "âœ… Testes: $TESTS"
        
    - name: ðŸ“¤ Upload relatÃ³rio de cobertura
      uses: actions/upload-artifact@v3
      with:
        name: jacoco-report-${{ github.sha }}
        path: target/site/jacoco/
        retention-days: 30
        
    - name: ðŸ’¬ Comentar PR (se aplicÃ¡vel)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const coverage = '${{ steps.coverage.outputs.coverage }}';
          const tests = '${{ steps.coverage.outputs.tests }}';
          const status = coverage >= 80 ? 'âœ…' : 'âš ï¸';
          
          const comment = `## ðŸ“Š RelatÃ³rio de Testes
          
          ${status} **Cobertura**: ${coverage}% (meta: â‰¥80%)
          ðŸ§ª **Testes**: ${tests} executados
          
          ðŸ“ RelatÃ³rio completo disponÃ­vel em Artifacts
          
          ---
          _Commit: ${context.sha.substring(0, 7)}_
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: âœ… Verificar cobertura mÃ­nima
      run: mvn jacoco:check
      
    - name: ðŸ“ Resumo
      run: |
        echo "### ðŸ“Š Resultados dos Testes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Cobertura**: ${{ steps.coverage.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
        echo "- **Testes**: ${{ steps.coverage.outputs.tests }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ steps.coverage.outputs.coverage >= 80 && 'âœ… Aprovado' || 'âš ï¸ Abaixo da meta' }}" >> $GITHUB_STEP_SUMMARY

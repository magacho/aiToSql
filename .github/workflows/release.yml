name: Release AutomÃ¡tico

on:
  push:
    tags:
      - 'REL-*'  # Dispara apenas em tags REL-X.X.X

jobs:
  release:
    name: Criar Release
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Buscar todo histÃ³rico
      
    - name: â˜• Configurar JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: ğŸ”– Extrair versÃ£o da tag
      id: version
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        VERSION=${TAG#REL-}
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Release: $VERSION"
        
    - name: ğŸ§ª Executar testes completos
      run: |
        echo "ğŸ§ª Executando suite completa de testes..."
        mvn clean test
        
    - name: ğŸ“Š Gerar relatÃ³rio de cobertura
      run: mvn jacoco:report
      
    - name: ğŸ“ˆ Extrair mÃ©tricas de cobertura
      id: metrics
      run: |
        COVERAGE=$(awk -F',' '{ instructions += $4 + $5; covered += $5 } END { printf "%.1f", 100*covered/instructions }' target/site/jacoco/jacoco.csv)
        TESTS=$(grep -oP '<test.*?name="\K[^"]+' target/surefire-reports/*.xml 2>/dev/null | wc -l || echo "0")
        FAILURES=$(grep -oP 'failures="\K\d+' target/surefire-reports/*.xml 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
        ERRORS=$(grep -oP 'errors="\K\d+' target/surefire-reports/*.xml 2>/dev/null | awk '{s+=$1} END {print s}' || echo "0")
        
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "tests=$TESTS" >> $GITHUB_OUTPUT
        echo "failures=$FAILURES" >> $GITHUB_OUTPUT
        echo "errors=$ERRORS" >> $GITHUB_OUTPUT
        
        echo "âœ… Cobertura: $COVERAGE%"
        echo "âœ… Testes: $TESTS"
        echo "âœ… Falhas: $FAILURES"
        echo "âœ… Erros: $ERRORS"
        
    - name: âŒ Falhar se testes falharem
      if: steps.metrics.outputs.failures != '0' || steps.metrics.outputs.errors != '0'
      run: |
        echo "âŒ Testes falharam! Release cancelado."
        echo "Falhas: ${{ steps.metrics.outputs.failures }}"
        echo "Erros: ${{ steps.metrics.outputs.errors }}"
        exit 1
        
    - name: âš ï¸ Alertar se cobertura baixa
      if: steps.metrics.outputs.coverage < 80
      run: |
        echo "âš ï¸ ATENÃ‡ÃƒO: Cobertura abaixo de 80% (${{ steps.metrics.outputs.coverage }}%)"
        echo "Considere adicionar mais testes antes da release."
        
    - name: ğŸ“¦ Comprimir relatÃ³rio JaCoCo
      run: |
        cd target/site
        zip -r jacoco-${{ steps.version.outputs.version }}.zip jacoco/
        cd ../..
        
    - name: ğŸ“¦ Empacotar aplicaÃ§Ã£o
      run: mvn package -DskipTests
      
    - name: ğŸ“ Atualizar RELEASE_HISTORY.md
      run: |
        DATE=$(date +"%d de %B de %Y")
        VERSION="${{ steps.version.outputs.version }}"
        COVERAGE="${{ steps.metrics.outputs.coverage }}"
        TESTS="${{ steps.metrics.outputs.tests }}"
        
        # Determinar status de cobertura
        if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
          STATUS="âœ…"
        elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          STATUS="ğŸŸ¢"
        else
          STATUS="âš ï¸"
        fi
        
        # Criar seÃ§Ã£o de release
        cat > release_section.md << EOL
        ## ğŸ“‹ VersÃ£o $VERSION

        **Data**: $DATE  
        **Status**: ğŸš€ ProduÃ§Ã£o

        ### ğŸ“Š Cobertura de Testes

        | MÃ©trica | Valor | Status |
        |---------|-------|--------|
        | **Cobertura Total** | $COVERAGE% | $STATUS |
        | **Total de Testes** | $TESTS | âœ… |
        | **Testes com Falha** | ${{ steps.metrics.outputs.failures }} | âœ… |

        ### âœ¨ Novas Funcionalidades

        - Release automÃ¡tico via tag REL-$VERSION
        - RelatÃ³rio de cobertura incluÃ­do

        ### ğŸ”§ CorreÃ§Ãµes

        - Melhorias gerais de estabilidade

        ### ğŸ“¦ Artefatos

        - JAR: aiToSql-$VERSION.jar
        - RelatÃ³rio JaCoCo: jacoco-$VERSION.zip

        ---

        EOL
        
        # Inserir no inÃ­cio do histÃ³rico (apÃ³s cabeÃ§alho)
        sed -i "/## ğŸ“‹ VersÃ£o 0.0.1-SNAPSHOT/r release_section.md" RELEASE_HISTORY.md
        
        cat RELEASE_HISTORY.md
        
    - name: ğŸ“ Gerar Release Notes
      id: notes
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        COVERAGE="${{ steps.metrics.outputs.coverage }}"
        TESTS="${{ steps.metrics.outputs.tests }}"
        
        cat > RELEASE_NOTES.md << EOL
        # Release v$VERSION

        ## ğŸ“Š MÃ©tricas de Qualidade

        - **Cobertura de Testes**: $COVERAGE%
        - **Total de Testes**: $TESTS
        - **Taxa de Sucesso**: 100%

        ## ğŸ¯ Destaques

        - âœ… Protocolo JSON-RPC 2.0 completo
        - âœ… 4 ferramentas MCP implementadas
        - âœ… Suporte multi-banco (PostgreSQL, MySQL, Oracle, MSSQL)
        - âœ… SeguranÃ§a SQL com validaÃ§Ã£o rigorosa
        - âœ… Cache de metadados otimizado

        ## ğŸ“¦ Artefatos IncluÃ­dos

        - \`aiToSql-$VERSION.jar\` - AplicaÃ§Ã£o completa
        - \`jacoco-$VERSION.zip\` - RelatÃ³rio de cobertura detalhado

        ## ğŸ“š DocumentaÃ§Ã£o

        - [README.md](README.md) - DocumentaÃ§Ã£o principal
        - [QUICKSTART.md](QUICKSTART.md) - Guia rÃ¡pido
        - [TESTING_GUIDE.md](TESTING_GUIDE.md) - Guia de testes
        - [COVERAGE_REPORT.md](COVERAGE_REPORT.md) - RelatÃ³rio de cobertura
        - [RELEASE_HISTORY.md](RELEASE_HISTORY.md) - HistÃ³rico completo

        ## ğŸš€ Como Usar

        \`\`\`bash
        # Download
        wget https://github.com/seu-usuario/aiToSql/releases/download/REL-$VERSION/aiToSql-$VERSION.jar

        # Executar
        java -jar aiToSql-$VERSION.jar
        \`\`\`

        ## ğŸ“ˆ EvoluÃ§Ã£o da Cobertura

        Esta release mantÃ©m a meta de cobertura â‰¥ 80% com $COVERAGE% de cÃ³digo testado.

        ---

        **Data de Release**: $(date +"%d/%m/%Y %H:%M:%S")  
        **Commit**: ${GITHUB_SHA:0:7}
        EOL
        
        echo "notes_file=RELEASE_NOTES.md" >> $GITHUB_OUTPUT
        
    - name: ğŸš€ Criar GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release v${{ steps.version.outputs.version }}
        body_path: RELEASE_NOTES.md
        files: |
          target/aiToSql-*.jar
          target/site/jacoco-${{ steps.version.outputs.version }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ’¾ Commit RELEASE_HISTORY.md atualizado
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add RELEASE_HISTORY.md
        git commit -m "docs: atualizar RELEASE_HISTORY.md para v${{ steps.version.outputs.version }}"
        git push origin HEAD:main
      continue-on-error: true
        
    - name: ğŸ“¤ Upload para Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./target/site/jacoco/jacoco.xml
        flags: release-${{ steps.version.outputs.version }}
        name: release-v${{ steps.version.outputs.version }}
        
    - name: ğŸ‰ Resumo da Release
      run: |
        echo "### ğŸ‰ Release v${{ steps.version.outputs.version }} Criado!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### ğŸ“Š MÃ©tricas" >> $GITHUB_STEP_SUMMARY
        echo "- **Cobertura**: ${{ steps.metrics.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
        echo "- **Testes**: ${{ steps.metrics.outputs.tests }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Todos os testes passaram" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### ğŸ“¦ Artefatos" >> $GITHUB_STEP_SUMMARY
        echo "- JAR: aiToSql-${{ steps.version.outputs.version }}.jar" >> $GITHUB_STEP_SUMMARY
        echo "- Cobertura: jacoco-${{ steps.version.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "[ğŸ”— Ver Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
